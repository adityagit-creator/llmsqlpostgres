<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LLM SQL Chatbot UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
      <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
        LLM SQL Chatbot
      </h1>
      <p class="text-gray-600 mb-6 text-center">
        Ask questions about your database in natural language (e.g., "Show me
        all users", "How many products cost more than 50?").
      </p>

      <div class="mb-6">
        <label
          for="queryInput"
          class="block text-gray-700 text-sm font-semibold mb-2"
          >Your Query:</label
        >
        <textarea
          id="queryInput"
          rows="3"
          class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 resize-y"
          placeholder="Type your natural language query here..."
        ></textarea>
      </div>

      <button
        id="sendButton"
        class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-300 shadow-md hover:shadow-lg"
      >
        Send Query
      </button>

      <div
        id="loadingIndicator"
        class="mt-6 text-center text-blue-600 font-medium hidden"
      >
        <svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24">
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        Processing query...
      </div>

      <div
        id="responseDisplay"
        class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg overflow-x-auto text-sm text-gray-800"
      >
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Response:</h2>
        <pre id="responseText" class="whitespace-pre-wrap break-words"></pre>
      </div>

      <div
        id="errorDisplay"
        class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden"
      >
        <p class="font-semibold">Error:</p>
        <pre id="errorMessage" class="whitespace-pre-wrap break-words"></pre>
      </div>
    </div>

    <script>
      const queryInput = document.getElementById("queryInput");
      const sendButton = document.getElementById("sendButton");
      const loadingIndicator = document.getElementById("loadingIndicator");
      const responseDisplay = document.getElementById("responseDisplay");
      const responseText = document.getElementById("responseText");
      const errorDisplay = document.getElementById("errorDisplay");
      const errorMessage = document.getElementById("errorMessage");
      const API_BASE_URL = "http://localhost:8000";

      sendButton.addEventListener("click", async () => {
        const query = queryInput.value.trim();

        if (!query) {
          displayError("Please enter a query.");
          return;
        }
        responseText.textContent = "";
        hideError();
        showLoading();

        try {
          const response = await fetch(`${API_BASE_URL}/api/chat`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ message: query }),
          });

          hideLoading();

          if (response.ok) {
            const data = await response.json();
            displayResponse(data);
          } else {
            const errorData = await response.json();
            displayError(
              errorData.detail ||
                `HTTP Error: ${response.status} ${response.statusText}`
            );
          }
        } catch (error) {
          hideLoading();
          displayError(
            `Network error: ${error.message}. Ensure the backend server is running at ${API_BASE_URL}`
          );
          console.error("Fetch error:", error);
        }
      });

      function showLoading() {
        loadingIndicator.classList.remove("hidden");
        sendButton.disabled = true;
        sendButton.classList.add("opacity-50", "cursor-not-allowed");
      }

      function hideLoading() {
        loadingIndicator.classList.add("hidden");
        sendButton.disabled = false;
        sendButton.classList.remove("opacity-50", "cursor-not-allowed");
      }

      function displayResponse(data) {
        if (data.error) {
          displayError(data.error);
          return;
        }
        if (data.columns && data.rows) {
          let formattedOutput = "";
          formattedOutput +=
            data.columns.map((col) => String(col).padEnd(20)).join(" | ") +
            "\n";
          formattedOutput += "-".repeat(data.columns.length * 23 - 3) + "\n";
          data.rows.forEach((row) => {
            formattedOutput +=
              row.map((cell) => String(cell).padEnd(20)).join(" | ") + "\n";
          });
          responseText.textContent = formattedOutput;
        } else if (data.message) {
          responseText.textContent = data.message;
        } else {
          responseText.textContent = JSON.stringify(data, null, 2);
        }
        responseDisplay.classList.remove("hidden");
      }

      function displayError(message) {
        errorMessage.textContent = message;
        errorDisplay.classList.remove("hidden");
        responseDisplay.classList.add("hidden");
      }
      function hideError() {
        errorDisplay.classList.add("hidden");
        errorMessage.textContent = "";
      }
    </script>
  </body>
</html>
